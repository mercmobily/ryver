
var ryver = require('ryver');
var marked = require('marked');

var eventEC = ryver.eventEC;

eventEC.onCollect( 'filter', function( cb ){

  var f = function( fileData, cb ){

    console.log("fileData", ryver.trimFileData( fileData ) );

    // This filter will only work on text files (of any kind)
    if( fileData.system.mimetype.split('/')[0] !== 'text') return cb( null, fileData);

    if( fileData.system.fileExt !== 'md' && fileData.system.fileExt !== 'markdown') return cb( null, fileData )

    marked.setOptions({
      renderer: new marked.Renderer(),
      gfm: true,
      tables: true,
      breaks: false,
      pedantic: false,
      sanitize: true,
      smartLists: true,
      smartypants: true
    });

    fileData.contents = marked( fileData.contents, fileData );

    ryver.changeFileExt( fileData.system, 'html' );
    fileData.system.mimetype = 'text/html';

    // All done.
    cb( null, fileData );
  }

  // Return the function just defined as the filter
  cb( null, { name: 'markup-markdown', executor: f } );
});
