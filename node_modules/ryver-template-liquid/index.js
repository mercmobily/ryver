
var ryver = require('ryver');
var liquid = require('tinyliquid');

var eventEC = ryver.eventEC;

eventEC.onCollect( 'filter', function( cb ){

  var f = function( fileData, cb ){

    console.log("fileData", ryver.trimFileData( fileData ) );

    // This filter will only work on text files (of any kind)
    if( fileData.system.mimetype.split('/')[0] !== 'text') return cb( null, fileData);

    var render = liquid.compile( fileData.contents );

    var context = liquid.newContext ({
      locals : fileData
    });

    render( context, function( err ){
      if( err ) return cb( err );

      fileData.contents = context.getBuffer();

      cb( null, fileData );
    });
  }

  // Return the function just defined as the filter
  cb( null, { name: 'template-liquid', executor: f } );
});
