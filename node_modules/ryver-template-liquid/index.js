
var ryver = require('ryver');
var liquid = require('tinyliquid');
var p = require('path');
var fs = require('fs.extra')

var eventEC = ryver.eventEC;

eventEC.onCollect( 'filter', function( cb ){

  var f = function( fileData, cb ){

    // This filter will only work on text files (of any kind)
    if( fileData.system.mimetype.split('/')[0] !== 'text'){
      ryver.log( "File ignored as mime type is not 'text':", fileData.system.mimetype );
      return cb( null, fileData);
    }

    var render = liquid.compile( fileData.contents );

    var context = liquid.newContext ({
      locals : fileData,
    });

    // Define onInclude so that `include` works
    context.onInclude( function( name, cb ){
      fs.readFile( p.join( fileData.system.filePath, name ), 'utf-8', function( err, included ){
        if( err ) return cb( err );

        var ast = liquid.parse( included );
        cb( null, ast );
      });
    });

    // Render the file using the created context
    render( context, function( err ){
      if( err ) return cb( err );

      fileData.contents = context.getBuffer();
      cb( null, fileData );
    });
  }

  // Return the function just defined as the filter
  cb( null, { name: 'template-liquid', executor: f } );
});
