
var ryver = require('ryver');
var p = require('path');
fs = require('fs.extra');

var eventEC = ryver.eventEC;

// filecopy
eventEC.onCollect( 'filter', function( cb ){

  var f = function( fileData, cb ){

    // If the file is to be hidden, goodbye
    if( fileData.info.hide ) return cb( null );

    //var relPath = substr( ryver.getSrc(), fileData.system.filePath

    var fullDest = p.join( ryver.getDst(), fileData.system.filePath );

    console.log( "getSrc: ", ryver.getSrc() );
    console.log( "getDst: ", ryver.getDst() );
    console.log("fileData.system.filePath: ", fileData.system.filePath );
    console.log("fullDest: ", fullDest );



    // Make the containing directory in the destination folder
    fs.mkdirp( fullDest, function( err ){
      if( err ) return cb( err );

      var s = fileData.system;
      fs.writeFile( p.join( fullDest, s.fileName + s.fileExt ), fileData.contents, function( err ){
        if( err ) return cb( null );
        cb( null, fileData );
      });

    });
  }

  // Return the function just defined as the filter
  cb( null, { name: 'filecopy', executor: f } );
});
