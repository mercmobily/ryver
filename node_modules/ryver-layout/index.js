
var ryver = require('ryver');
var fs = require('fs');
var p = require('path');

var eventEC = ryver.eventEC;

eventEC.onCollect( 'filter', function( cb ){

  var f = function( fileData, cb ){

    // This filter will only work on text files (of any kind)
    if( fileData.system.mimetype.split('/')[0] !== 'text'){
      ryver.log( "File ignored as mime type is not 'text'" );
      return cb( null, fileData);
    }
    
    // Sets the layout. If it's not defined, quit it
    var layout = fileData.info.layout || ( fileData.frontMatter && fileData.frontMatter.layout );
    if( !layout ) return cb( null, fileData );

    fs.readFile( p.join( fileData.system.src, '_layout', layout ), function( err, templatefileContentsAsBuffer ){
      if( err ) return cb( err );

      var templatefileContents = templatefileContentsAsBuffer.toString();

      var templatefileContentsParts = templatefileContents.split('<!--contents-->' );
      if( templatefileContentsParts.length  != 2 ) return cb( new Error("Tag <!--contents--> not found in template") );

      fileData.contents = templatefileContentsParts[ 0 ] + fileData.contents + templatefileContentsParts[ 1 ];

      // All done.
      cb( null, fileData );
    });
  }

  // Return the function just defined as the filter
  cb( null, { name: 'layout', executor: f } );
});
